From b984862c268c0450045f50a5bb9942ee8f5097bb Mon Sep 17 00:00:00 2001
From: Yiyu Si <1486864380@qq.com>
Date: Sat, 20 Aug 2022 10:30:41 +0800
Subject: [PATCH] Akarin PlayerConnectionUtils


diff --git a/src/main/java/net/minecraft/server/PlayerConnectionUtils.java b/src/main/java/net/minecraft/server/PlayerConnectionUtils.java
index 1fc632e0c..884a3de70 100644
--- a/src/main/java/net/minecraft/server/PlayerConnectionUtils.java
+++ b/src/main/java/net/minecraft/server/PlayerConnectionUtils.java
@@ -2,14 +2,16 @@ package net.minecraft.server;
 
 import co.aikar.timings.MinecraftTimings; // Paper
 import co.aikar.timings.Timing; // Paper
+import io.akarin.api.internal.Akari; //Akarin
 
 public class PlayerConnectionUtils {
-
+    //Akarin Start
     // Paper start, fix decompile and add timings
     public static <T extends PacketListener> void ensureMainThread(final Packet<T> packet, final T listener, IAsyncTaskHandler iasynctaskhandler) throws CancelledPacketHandleException {
         if (!iasynctaskhandler.isMainThread()) {
             Timing timing = MinecraftTimings.getPacketTiming(packet);
-            iasynctaskhandler.postToMainThread(() -> {
+            // MinecraftServer#postToMainThread inlined thread check, no twice
+            Akari.callbackQueue.add(() -> {
                 try (Timing ignored = timing.startTiming()) {
                     packet.a(listener);
                 }
@@ -18,4 +20,5 @@ public class PlayerConnectionUtils {
         }
     }
     // Paper end
+    //Akarin End
 }
-- 
2.35.1.windows.2

