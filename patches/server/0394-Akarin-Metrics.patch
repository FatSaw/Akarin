From ca4306b71f62372473e987ec851437bc5e3f832e Mon Sep 17 00:00:00 2001
From: Yiyu Si <1486864380@qq.com>
Date: Fri, 19 Aug 2022 14:45:48 +0800
Subject: [PATCH] Akarin Metrics


diff --git a/src/main/java/com/destroystokyo/paper/Metrics.java b/src/main/java/com/destroystokyo/paper/Metrics.java
index 05f9e7849..b714f44ff 100644
--- a/src/main/java/com/destroystokyo/paper/Metrics.java
+++ b/src/main/java/com/destroystokyo/paper/Metrics.java
@@ -30,8 +30,8 @@ public class Metrics {
     // The version of this bStats class
     public static final int B_STATS_VERSION = 1;
 
-    // The url to which the data is sent
-    private static final String URL = "https://bStats.org/submitData/server-implementation";
+    // The url to which the data is sent - bukkit/Torch (keep our old name)
+    private final static String URL = "https://bStats.org/submitData/bukkit"; //Akarin
 
     // Should failed requests be logged?
     private static boolean logFailedRequests = false;
@@ -103,15 +103,8 @@ public class Metrics {
         JSONObject data = new JSONObject();
 
         data.put("pluginName", name); // Append the name of the server software
+        data.put("pluginVersion", Metrics.class.getPackage().getImplementationVersion() != null ? Metrics.class.getPackage().getImplementationVersion() : "unknown"); // Akarin
         JSONArray customCharts = new JSONArray();
-        for (CustomChart customChart : charts) {
-            // Add the data of the custom charts
-            JSONObject chart = customChart.getRequestJsonObject();
-            if (chart == null) { // If the chart is null, we skip it
-                continue;
-            }
-            customCharts.add(chart);
-        }
         data.put("customCharts", customCharts);
 
         return data;
@@ -123,14 +116,23 @@ public class Metrics {
      * @return The server specific data.
      */
     private JSONObject getServerData() {
+        // Minecraft specific data
+        int playerAmount = Bukkit.getOnlinePlayers().size();
+        int onlineMode = Bukkit.getOnlineMode() ? 1 : 0;
+        String bukkitVersion = org.bukkit.Bukkit.getVersion();
+        bukkitVersion = bukkitVersion.substring(bukkitVersion.indexOf("MC: ") + 4, bukkitVersion.length() - 1);
+        
+        JSONObject data = new JSONObject();
+        data.put("playerAmount", playerAmount);
+        data.put("onlineMode", onlineMode);
+        data.put("bukkitVersion", bukkitVersion);
+        
         // OS specific data
         String osName = System.getProperty("os.name");
         String osArch = System.getProperty("os.arch");
         String osVersion = System.getProperty("os.version");
         int coreCount = Runtime.getRuntime().availableProcessors();
 
-        JSONObject data = new JSONObject();
-
         data.put("serverUUID", serverUUID);
 
         data.put("osName", osName);
-- 
2.35.1.windows.2

